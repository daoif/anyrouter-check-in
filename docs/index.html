<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置管理器 | AnyRouter 签到</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --border-color: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-lg: 12px;
            --radius-md: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            line-height: 1.5;
            padding: 2rem 1rem;
            background-image:
                radial-gradient(at 0% 0%, rgba(79,70,229,0.08) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(16,185,129,0.08) 0px, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
        }
        .container { max-width: 800px; margin: 0 auto; }

        /* Header */
        header { text-align: center; margin-bottom: 2.5rem; }
        header h1 {
            font-size: 2rem; font-weight: 800;
            background: linear-gradient(135deg, var(--primary), #818cf8);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }
        header p { color: var(--text-muted); font-size: 1.05rem; }

        /* Cards */
        .card {
            background: var(--bg-card); border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md); border: 1px solid rgba(255,255,255,0.5);
            margin-bottom: 1.5rem; overflow: hidden;
        }
        .card:hover { box-shadow: var(--shadow-lg); }
        .card-header {
            padding: 1rem 1.25rem; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(248,250,252,0.5); cursor: pointer; user-select: none;
        }
        .card-title {
            font-weight: 600; font-size: 1.05rem;
            display: flex; align-items: center; gap: 0.6rem;
        }
        .card-icon { width: 22px; height: 22px; color: var(--primary); }
        .card-body { padding: 1.25rem; }
        .card-body.hidden { display: none; }
        .chevron { transition: transform 0.2s; }
        .chevron.open { transform: rotate(180deg); }

        /* Badge */
        .badge {
            display: inline-flex; padding: 0.2rem 0.6rem;
            border-radius: 9999px; font-size: 0.7rem; font-weight: 600;
        }
        .badge-primary { background: #e0e7ff; color: var(--primary); }
        .badge-warning { background: #fef3c7; color: #d97706; }

        /* Forms */
        .form-group { margin-bottom: 1rem; }
        .form-group:last-child { margin-bottom: 0; }
        label {
            display: block; font-size: 0.85rem; font-weight: 500;
            margin-bottom: 0.4rem;
        }
        input[type="text"], input[type="email"], input[type="password"],
        input[type="number"], select, textarea {
            width: 100%; padding: 0.65rem 0.85rem;
            border: 1px solid var(--border-color); border-radius: var(--radius-md);
            font-family: inherit; font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s; background: #fff;
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79,70,229,0.1);
        }
        input.invalid { border-color: var(--danger); background: #fef2f2; }
        .help-text { font-size: 0.78rem; color: var(--text-muted); margin-top: 0.3rem; }
        .error-text {
            font-size: 0.78rem; color: var(--danger); margin-top: 0.3rem;
            display: none; align-items: center; gap: 0.25rem;
        }
        .error-text.visible { display: flex; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.85rem; }
        .grid-3 { display: grid; grid-template-columns: 2fr 2fr 1fr; gap: 0.85rem; }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.65rem 1.25rem; border-radius: var(--radius-md);
            font-weight: 500; cursor: pointer; transition: all 0.2s;
            border: none; gap: 0.4rem; font-size: 0.9rem; font-family: inherit;
        }
        .btn-primary {
            background: var(--primary); color: #fff; width: 100%;
            box-shadow: 0 4px 6px -1px rgba(79,70,229,0.3);
        }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-outline {
            background: transparent; border: 1px dashed var(--border-color);
            color: var(--text-muted); width: 100%;
        }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); background: #f8fafc; }
        .btn-danger-soft {
            background: #fee2e2; color: #ef4444;
            padding: 0.35rem 0.7rem; font-size: 0.8rem; border: none;
            border-radius: 4px; cursor: pointer;
        }
        .btn-danger-soft:hover { background: #fecaca; }
        .btn-group { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; }
        .btn-group .btn { flex: 1; }
        .btn-secondary {
            background: #f1f5f9; color: var(--text-main);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-danger { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; }
        .btn-danger:hover { background: #fecaca; }

        /* Account Item */
        .account-item {
            background: #f8fafc; border: 1px solid var(--border-color);
            border-radius: var(--radius-md); padding: 1.1rem;
            margin-bottom: 0.85rem; position: relative;
        }
        .account-header-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 0.85rem; padding-bottom: 0.6rem;
            border-bottom: 1px solid var(--border-color);
        }

        /* Output */
        .output-container { margin-top: 1.5rem; display: none; }
        .secret-card {
            background: #1e293b; border-radius: var(--radius-md);
            margin-bottom: 0.85rem; overflow: hidden; border: 1px solid #334155;
        }
        .secret-header {
            background: #0f172a; padding: 0.6rem 0.85rem;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #334155;
        }
        .secret-name {
            color: #e2e8f0; font-family: "JetBrains Mono", "Cascadia Code", "Fira Code", monospace;
            font-size: 0.85rem; font-weight: 500;
        }
        .secret-content {
            padding: 0.85rem; color: #94a3b8;
            font-family: "JetBrains Mono", "Cascadia Code", "Fira Code", monospace;
            font-size: 0.8rem; overflow-x: auto; white-space: pre-wrap;
            word-break: break-all; max-height: 200px;
        }
        .copy-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: #e2e8f0; padding: 0.3rem 0.6rem; border-radius: 6px;
            font-size: 0.75rem; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 4px; font-family: inherit;
        }
        .copy-btn:hover { background: rgba(255,255,255,0.2); }
        .copy-btn.copied { background: var(--success); border-color: var(--success); color: #fff; }

        /* Toast */
        .toast {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #1e293b; color: #fff; padding: 0.65rem 1.25rem;
            border-radius: 9999px; box-shadow: var(--shadow-lg);
            display: flex; align-items: center; gap: 0.6rem;
            z-index: 100; transition: transform 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
            font-size: 0.85rem; font-weight: 500;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* Divider */
        .divider { border: 0; border-top: 1px dashed var(--border-color); margin: 1.25rem 0; }

        /* Save indicator */
        .save-indicator {
            position: fixed; bottom: 20px; right: 20px;
            background: var(--success); color: #fff; padding: 0.5rem 1rem;
            border-radius: 9999px; font-size: 0.8rem; font-weight: 500;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .save-indicator.show { opacity: 1; }

        .icon { width: 1.15em; height: 1.15em; stroke-width: 2; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<!-- Toast -->
<div id="toast" class="toast">
    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" style="color:#4ade80"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
    <span></span>
</div>

<!-- Save indicator -->
<div id="saveIndicator" class="save-indicator">已自动保存</div>

<!-- File input for import -->
<input type="file" id="importFile" accept=".json">

<div class="container">
    <header>
        <h1>AnyRouter 签到配置管理器</h1>
        <p>管理账号、通知渠道，一键生成 GitHub Secrets 配置</p>
    </header>

    <!-- Guide Card -->
    <div class="card">
        <div class="card-header" onclick="toggleCard(this)">
            <div class="card-title">
                <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                使用指南
            </div>
            <svg class="icon chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
        </div>
        <div class="card-body">
            <ol style="padding-left:1.4rem; color:var(--text-muted); line-height:1.9; font-size:0.92rem;">
                <li>在浏览器中登录 AnyRouter，按 <strong>F12</strong> 打开开发者工具。</li>
                <li>在 Application &gt; Cookies 中找到 <code>session</code> 值并复制。</li>
                <li>在下方 <strong>账号配置</strong> 中粘贴 Session Cookie。</li>
                <li>按需配置通知渠道（钉钉、飞书、Telegram 等）。</li>
                <li>点击 <strong>"生成配置"</strong>，将生成的值复制到 GitHub 仓库的 Secrets 中。</li>
                <li>在 GitHub 仓库 Settings &gt; Environments 中创建名为 <code>production</code> 的环境。</li>
            </ol>
            <div class="help-text" style="margin-top:0.8rem;">
                所有数据仅保存在浏览器本地 (localStorage)，不会上传到任何服务器。
            </div>
        </div>
    </div>

    <!-- Accounts Card -->
    <div class="card">
        <div class="card-header" style="cursor:default">
            <div class="card-title">
                <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                账号配置 (ANYROUTER_ACCOUNTS)
                <span class="badge badge-primary">必需</span>
            </div>
        </div>
        <div class="card-body">
            <div id="accountsContainer"></div>
            <button type="button" class="btn btn-outline" onclick="addAccount()">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                添加账号
            </button>
        </div>
    </div>

    <!-- Providers Card -->
    <div class="card">
        <div class="card-header" onclick="toggleCard(this)">
            <div class="card-title">
                <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>
                服务商配置 (PROVIDERS)
                <span class="badge badge-warning">可选</span>
            </div>
            <svg class="icon chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
        </div>
        <div class="card-body hidden">
            <div id="providersContainer"></div>
            <button type="button" class="btn btn-outline" onclick="addProvider()">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                添加自定义服务商
            </button>
            <div class="help-text" style="margin-top:0.8rem;">内置 <code>anyrouter</code> 和 <code>agentrouter</code>，通常无需额外配置。</div>
        </div>
    </div>

    <!-- Notifications Card -->
    <div class="card">
        <div class="card-header" onclick="toggleCard(this)">
            <div class="card-title">
                <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                通知设置
                <span class="badge badge-warning">可选</span>
            </div>
            <svg class="icon chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
        </div>
        <div class="card-body hidden" id="notificationsBody">
            <div class="form-group">
                <label>邮件通知 (SMTP)</label>
                <div class="grid-2">
                    <input type="email" id="n_emailUser" placeholder="发件邮箱" oninput="autoSave()">
                    <input type="password" id="n_emailPass" placeholder="邮箱密码/授权码" oninput="autoSave()">
                </div>
                <div class="grid-2" style="margin-top:0.6rem">
                    <input type="email" id="n_emailTo" placeholder="收件邮箱 (留空同发件)" oninput="autoSave()">
                    <input type="text" id="n_emailSender" placeholder="发件人显示名 (可选)" oninput="autoSave()">
                </div>
                <div style="margin-top:0.6rem">
                    <input type="text" id="n_customSmtp" placeholder="自定义 SMTP 服务器 (可选，自动识别常见邮箱)" oninput="autoSave()">
                </div>
            </div>
            <hr class="divider">
            <div class="form-group">
                <label>推送服务</label>
                <div style="display:grid; gap:0.6rem;">
                    <input type="text" id="n_pushplusToken" placeholder="PushPlus Token" oninput="autoSave()">
                    <input type="text" id="n_serverpushkey" placeholder="Server酱 SendKey" oninput="autoSave()">
                </div>
            </div>
            <hr class="divider">
            <div class="form-group">
                <label>Webhook 通知</label>
                <div style="display:grid; gap:0.6rem;">
                    <input type="text" id="n_dingdingWebhook" placeholder="钉钉 Webhook URL" oninput="autoSave()">
                    <input type="text" id="n_feishuWebhook" placeholder="飞书 Webhook URL" oninput="autoSave()">
                    <input type="text" id="n_weixinWebhook" placeholder="企业微信 Webhook URL" oninput="autoSave()">
                </div>
            </div>
            <hr class="divider">
            <div class="form-group">
                <label>Telegram</label>
                <div class="grid-2">
                    <input type="text" id="n_telegramToken" placeholder="Bot Token" oninput="autoSave()">
                    <input type="text" id="n_telegramChatId" placeholder="Chat ID" oninput="autoSave()">
                </div>
            </div>
            <hr class="divider">
            <div class="form-group">
                <label>Gotify</label>
                <div class="grid-3">
                    <input type="text" id="n_gotifyUrl" placeholder="Gotify URL" oninput="autoSave()">
                    <input type="text" id="n_gotifyToken" placeholder="Token" oninput="autoSave()">
                    <input type="number" id="n_gotifyPriority" placeholder="优先级" min="1" max="10" oninput="autoSave()">
                </div>
            </div>
            <hr class="divider">
            <div class="form-group">
                <label>Bark</label>
                <div class="grid-2">
                    <input type="text" id="n_barkKey" placeholder="Bark Key" oninput="autoSave()">
                    <input type="text" id="n_barkServer" placeholder="Bark Server (默认 api.day.app)" oninput="autoSave()">
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <button type="button" class="btn btn-primary" onclick="generateSecrets()" style="height:48px; font-size:1.05rem; margin-bottom:0.85rem;">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
        生成配置
    </button>

    <div class="btn-group">
        <button type="button" class="btn btn-secondary" onclick="exportConfig()">导出备份</button>
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('importFile').click()">导入备份</button>
        <button type="button" class="btn btn-danger" onclick="clearAll()">清空数据</button>
    </div>

    <!-- Output Section -->
    <div id="outputSection" class="output-container">
        <h3 style="margin-bottom:0.85rem; font-weight:600;">生成结果</h3>
        <div id="secretsOutput"></div>
    </div>
</div>

<script>
/* ========== Storage ========== */
const STORAGE_KEY = 'anyrouter-checkin-config';

function loadConfig() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) return JSON.parse(raw);
    } catch (e) { /* ignore */ }
    return { accounts: [], providers: {}, notifications: {} };
}

function saveConfig(cfg) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
    const el = document.getElementById('saveIndicator');
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 1200);
}

function getConfig() {
    // Build config from current DOM state
    const cfg = { accounts: [], providers: {}, notifications: {} };

    // Accounts
    document.querySelectorAll('.account-item[data-type="account"]').forEach(el => {
        const idx = el.dataset.idx;
        cfg.accounts.push({
            provider: qs(el, '.a-provider').value,
            name: qs(el, '.a-name').value.trim(),
            session: qs(el, '.a-session').value.trim(),
            apiUser: qs(el, '.a-apiuser').value.trim(),
            autoId: qs(el, '.a-autoid').checked,
        });
    });

    // Providers
    document.querySelectorAll('.account-item[data-type="provider"]').forEach(el => {
        const id = qs(el, '.p-id').value.trim();
        if (!id) return;
        const p = { domain: qs(el, '.p-domain').value.trim().replace(/\/+$/, '') };
        const v = (sel) => qs(el, sel).value.trim().replace(/\/+$/, '');
        if (v('.p-signin')) p.sign_in_path = v('.p-signin');
        if (v('.p-userinfo')) p.user_info_path = v('.p-userinfo');
        if (v('.p-userkey')) p.api_user_key = v('.p-userkey');
        const bypass = qs(el, '.p-bypass').value;
        if (bypass) p.bypass_method = bypass;
        if (v('.p-wafcookies')) {
            try { p.waf_cookie_names = JSON.parse(v('.p-wafcookies')); } catch(e) {}
        }
        cfg.providers[id] = p;
    });

    // Notifications
    const nIds = [
        'emailUser','emailPass','emailTo','emailSender','customSmtp',
        'pushplusToken','serverpushkey',
        'dingdingWebhook','feishuWebhook','weixinWebhook',
        'telegramToken','telegramChatId',
        'gotifyUrl','gotifyToken','gotifyPriority',
        'barkKey','barkServer'
    ];
    nIds.forEach(k => {
        const el = document.getElementById('n_' + k);
        if (el) cfg.notifications[k] = el.value;
    });

    return cfg;
}

function autoSave() {
    saveConfig(getConfig());
}

function qs(parent, sel) { return parent.querySelector(sel); }

/* ========== Toast ========== */
let toastTimer;
function showToast(msg, isError) {
    const t = document.getElementById('toast');
    t.querySelector('span').textContent = msg;
    const icon = t.querySelector('svg');
    icon.style.color = isError ? '#ef4444' : '#4ade80';
    icon.innerHTML = isError
        ? '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>'
        : '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>';
    t.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}

/* ========== Card Toggle ========== */
function toggleCard(header) {
    const body = header.nextElementSibling;
    const icon = header.querySelector('.chevron');
    body.classList.toggle('hidden');
    icon.classList.toggle('open');
}

/* ========== Accounts ========== */
let accountUid = 0;

function addAccount(data) {
    accountUid++;
    const d = data || { provider: 'anyrouter', name: '', session: '', apiUser: '', autoId: true };
    const container = document.getElementById('accountsContainer');
    const div = document.createElement('div');
    div.className = 'account-item';
    div.dataset.type = 'account';
    div.dataset.idx = accountUid;
    div.innerHTML = `
        <div class="account-header-row">
            <span style="font-weight:600">账号 #${accountUid}</span>
            <button type="button" class="btn-danger-soft" onclick="this.closest('.account-item').remove(); autoSave(); updateProviderDropdowns();">删除</button>
        </div>
        <div class="grid-2" style="margin-bottom:0.85rem">
            <div class="form-group" style="margin-bottom:0">
                <label>服务商</label>
                <select class="a-provider" onchange="autoSave()">
                    <option value="anyrouter">anyrouter (默认)</option>
                    <option value="agentrouter">agentrouter</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom:0">
                <label>备注名称 (可选)</label>
                <input type="text" class="a-name" placeholder="例如: 主账号" value="${escapeAttr(d.name)}" oninput="autoSave()">
            </div>
        </div>
        <div class="form-group">
            <label>Session Cookie <span style="color:var(--danger)">*</span></label>
            <textarea class="a-session" rows="2" placeholder="粘贴 session cookie 值..." oninput="onSessionInput(this); autoSave();">${escapeHtml(d.session)}</textarea>
            <div class="error-text"><span></span></div>
        </div>
        <div class="form-group">
            <label>API User ID <span style="color:var(--danger)">*</span></label>
            <input type="text" class="a-apiuser" placeholder="${d.autoId ? '自动提取中...' : '手动输入 User ID'}" value="${escapeAttr(d.apiUser)}" ${d.autoId ? 'readonly style="background:#f1f5f9;cursor:not-allowed"' : ''} oninput="autoSave()">
            <div class="help-text">
                <label style="display:inline-flex;align-items:center;cursor:pointer;font-size:0.78rem;">
                    <input type="checkbox" class="a-autoid" ${d.autoId ? 'checked' : ''} onchange="toggleAutoId(this)" style="width:auto;margin-right:5px;">
                    从 Session 自动提取
                    <span style="color:var(--warning);margin-left:4px;font-size:0.72rem;">(可能不准确)</span>
                </label>
            </div>
        </div>
    `;
    container.appendChild(div);

    // Set provider value after DOM insertion
    qs(div, '.a-provider').value = d.provider;
    updateProviderDropdowns();

    // Auto-extract if session exists
    if (d.session && d.autoId && !d.apiUser) {
        onSessionInput(qs(div, '.a-session'));
    }
}

function toggleAutoId(checkbox) {
    const item = checkbox.closest('.account-item');
    const input = qs(item, '.a-apiuser');
    if (checkbox.checked) {
        input.readOnly = true;
        input.style.backgroundColor = '#f1f5f9';
        input.style.cursor = 'not-allowed';
        input.placeholder = '自动提取中...';
        onSessionInput(qs(item, '.a-session'));
    } else {
        input.readOnly = false;
        input.style.backgroundColor = '#fff';
        input.style.cursor = 'text';
        input.placeholder = '手动输入 User ID (数字)';
        input.focus();
    }
    autoSave();
}

function onSessionInput(textarea) {
    const item = textarea.closest('.account-item');
    const val = textarea.value.trim();
    const errorEl = qs(item, '.error-text');
    const apiInput = qs(item, '.a-apiuser');
    const autoCheck = qs(item, '.a-autoid');

    if (!val) {
        textarea.classList.remove('invalid');
        errorEl.classList.remove('visible');
        return;
    }

    try {
        const b64 = val.replace(/-/g, '+').replace(/_/g, '/');
        const padded = b64.padEnd(b64.length + (4 - b64.length % 4) % 4, '=');
        const decoded = atob(padded);
        const parts = decoded.split('|');
        if (parts.length < 3) throw new Error('invalid');

        if (autoCheck.checked) {
            try {
                const pB64 = parts[1].replace(/-/g, '+').replace(/_/g, '/');
                const pd = atob(pB64);
                const m = pd.match(/(\d{5,10})/g);
                if (m) {
                    apiInput.value = m[0];
                } else {
                    apiInput.value = '';
                    apiInput.placeholder = '未能提取，请手动输入';
                }
            } catch(e) {
                apiInput.value = '';
                apiInput.placeholder = '未能提取，请手动输入';
            }
        }
        textarea.classList.remove('invalid');
        errorEl.classList.remove('visible');
    } catch(e) {
        textarea.classList.add('invalid');
        qs(errorEl, 'span').textContent = 'Session 格式无效 (Base64 解码失败)';
        errorEl.classList.add('visible');
    }
}

/* ========== Providers ========== */
let providerUid = 0;

function addProvider(data) {
    providerUid++;
    const d = data || {};
    const container = document.getElementById('providersContainer');
    const div = document.createElement('div');
    div.className = 'account-item';
    div.dataset.type = 'provider';
    div.dataset.idx = providerUid;
    div.innerHTML = `
        <div class="account-header-row">
            <span style="font-weight:600">自定义服务商 #${providerUid}</span>
            <button type="button" class="btn-danger-soft" onclick="this.closest('.account-item').remove(); autoSave(); updateProviderDropdowns();">删除</button>
        </div>
        <div class="grid-2" style="margin-bottom:0.85rem">
            <div class="form-group" style="margin-bottom:0">
                <label>标识名 (ID) <span style="color:var(--danger)">*</span></label>
                <input type="text" class="p-id" placeholder="例如: customrouter" value="${escapeAttr(d._id || '')}" oninput="updateProviderDropdowns(); autoSave();">
            </div>
            <div class="form-group" style="margin-bottom:0">
                <label>域名 <span style="color:var(--danger)">*</span></label>
                <input type="text" class="p-domain" placeholder="https://example.com" value="${escapeAttr(d.domain || '')}" oninput="autoSave()">
            </div>
        </div>
        <div class="grid-2" style="margin-bottom:0.85rem">
            <div class="form-group" style="margin-bottom:0">
                <label>签到路径</label>
                <input type="text" class="p-signin" placeholder="/api/user/sign_in" value="${escapeAttr(d.sign_in_path || '')}" oninput="autoSave()">
            </div>
            <div class="form-group" style="margin-bottom:0">
                <label>用户信息路径</label>
                <input type="text" class="p-userinfo" placeholder="/api/user/self" value="${escapeAttr(d.user_info_path || '')}" oninput="autoSave()">
            </div>
        </div>
        <div class="grid-2" style="margin-bottom:0.85rem">
            <div class="form-group" style="margin-bottom:0">
                <label>API User 请求头</label>
                <input type="text" class="p-userkey" placeholder="new-api-user" value="${escapeAttr(d.api_user_key || '')}" oninput="autoSave()">
            </div>
            <div class="form-group" style="margin-bottom:0">
                <label>绕过方法</label>
                <select class="p-bypass" onchange="autoSave()">
                    <option value="">无 (直接请求)</option>
                    <option value="waf_cookies" ${d.bypass_method === 'waf_cookies' ? 'selected' : ''}>waf_cookies</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>WAF Cookie 名称 (JSON 数组)</label>
            <input type="text" class="p-wafcookies" placeholder='["acw_tc", "cdn_sec_tc"]' value="${escapeAttr(d.waf_cookie_names ? JSON.stringify(d.waf_cookie_names) : '')}" oninput="autoSave()">
        </div>
    `;
    container.appendChild(div);
    updateProviderDropdowns();
}

function updateProviderDropdowns() {
    const customIds = [];
    document.querySelectorAll('.account-item[data-type="provider"] .p-id').forEach(el => {
        const v = el.value.trim();
        if (v) customIds.push(v);
    });
    document.querySelectorAll('.a-provider').forEach(sel => {
        const cur = sel.value;
        // Remove custom options
        while (sel.options.length > 2) sel.remove(2);
        customIds.forEach(id => {
            const opt = document.createElement('option');
            opt.value = id; opt.textContent = id;
            sel.appendChild(opt);
        });
        if ([...sel.options].some(o => o.value === cur)) sel.value = cur;
    });
}

/* ========== Generate Secrets ========== */
function generateSecrets() {
    const secrets = {};
    const accounts = [];

    document.querySelectorAll('.account-item[data-type="account"]').forEach(el => {
        const session = qs(el, '.a-session').value.trim();
        const apiUser = qs(el, '.a-apiuser').value.trim();
        const name = qs(el, '.a-name').value.trim();
        const provider = qs(el, '.a-provider').value;

        if (!session || !apiUser) return;
        const acc = { cookies: { session }, api_user: apiUser };
        if (name) acc.name = name;
        if (provider !== 'anyrouter') acc.provider = provider;
        accounts.push(acc);
    });

    if (accounts.length === 0) {
        showToast('请至少配置一个有效的账号 (需要 Session 和 API User ID)', true);
        return;
    }
    secrets.ANYROUTER_ACCOUNTS = JSON.stringify(accounts, null, 2);

    // Providers
    const providers = {};
    document.querySelectorAll('.account-item[data-type="provider"]').forEach(el => {
        const id = qs(el, '.p-id').value.trim();
        const domain = qs(el, '.p-domain').value.trim().replace(/\/+$/, '');
        if (!id || !domain) return;
        const p = { domain };
        const v = (s) => qs(el, s).value.trim().replace(/\/+$/, '');
        if (v('.p-signin')) p.sign_in_path = v('.p-signin');
        if (v('.p-userinfo')) p.user_info_path = v('.p-userinfo');
        if (v('.p-userkey')) p.api_user_key = v('.p-userkey');
        const bypass = qs(el, '.p-bypass').value;
        if (bypass) p.bypass_method = bypass;
        if (v('.p-wafcookies')) {
            try { p.waf_cookie_names = JSON.parse(v('.p-wafcookies')); } catch(e) {}
        }
        providers[id] = p;
    });
    if (Object.keys(providers).length > 0) {
        secrets.PROVIDERS = JSON.stringify(providers, null, 2);
    }

    // Notifications
    const nMap = {
        emailUser: 'EMAIL_USER', emailPass: 'EMAIL_PASS', emailTo: 'EMAIL_TO',
        emailSender: 'EMAIL_SENDER', customSmtp: 'CUSTOM_SMTP_SERVER',
        pushplusToken: 'PUSHPLUS_TOKEN', serverpushkey: 'SERVERPUSHKEY',
        dingdingWebhook: 'DINGDING_WEBHOOK', feishuWebhook: 'FEISHU_WEBHOOK',
        weixinWebhook: 'WEIXIN_WEBHOOK',
        telegramToken: 'TELEGRAM_BOT_TOKEN', telegramChatId: 'TELEGRAM_CHAT_ID',
        gotifyUrl: 'GOTIFY_URL', gotifyToken: 'GOTIFY_TOKEN', gotifyPriority: 'GOTIFY_PRIORITY',
        barkKey: 'BARK_KEY', barkServer: 'BARK_SERVER',
    };
    Object.entries(nMap).forEach(([k, envKey]) => {
        const el = document.getElementById('n_' + k);
        const val = el ? el.value.trim() : '';
        if (val) secrets[envKey] = val;
    });

    renderOutput(secrets);
}

function renderOutput(secrets) {
    const container = document.getElementById('secretsOutput');
    const section = document.getElementById('outputSection');
    let html = '';
    for (const [key, val] of Object.entries(secrets)) {
        const eid = 'secret_' + key;
        html += `
            <div class="secret-card">
                <div class="secret-header">
                    <span class="secret-name">${key}</span>
                    <div style="display:flex;gap:0.4rem">
                        <button class="copy-btn" onclick="copyText(this,'${key}')">名称</button>
                        <button class="copy-btn" onclick="copyText(this,document.getElementById('${eid}').textContent)">值</button>
                    </div>
                </div>
                <div class="secret-content" id="${eid}">${escapeHtml(val)}</div>
            </div>`;
    }
    container.innerHTML = html;
    section.style.display = 'block';
    section.scrollIntoView({ behavior: 'smooth' });
    showToast('配置已生成，请复制到 GitHub Secrets');
}

/* ========== Copy ========== */
function copyText(btn, text) {
    navigator.clipboard.writeText(text).then(() => {
        const orig = btn.textContent;
        btn.classList.add('copied');
        btn.textContent = '已复制';
        setTimeout(() => { btn.classList.remove('copied'); btn.textContent = orig; }, 1500);
    });
}

/* ========== Import / Export ========== */
function exportConfig() {
    const cfg = getConfig();
    const blob = new Blob([JSON.stringify(cfg, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'anyrouter-config-backup.json';
    a.click();
    URL.revokeObjectURL(a.href);
    showToast('配置已导出');
}

document.getElementById('importFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
        try {
            const cfg = JSON.parse(ev.target.result);
            loadFromConfig(cfg);
            saveConfig(cfg);
            showToast('配置已导入');
        } catch(err) {
            showToast('导入失败: JSON 格式无效', true);
        }
    };
    reader.readAsText(file);
    e.target.value = '';
});

function clearAll() {
    if (!confirm('确定要清空所有配置数据吗？此操作不可撤销。')) return;
    localStorage.removeItem(STORAGE_KEY);
    document.getElementById('accountsContainer').innerHTML = '';
    document.getElementById('providersContainer').innerHTML = '';
    // Clear notification fields
    document.querySelectorAll('[id^="n_"]').forEach(el => el.value = '');
    document.getElementById('outputSection').style.display = 'none';
    addAccount();
    showToast('所有数据已清空');
}

/* ========== Init ========== */
function loadFromConfig(cfg) {
    document.getElementById('accountsContainer').innerHTML = '';
    document.getElementById('providersContainer').innerHTML = '';
    accountUid = 0;
    providerUid = 0;

    // Accounts
    if (cfg.accounts && cfg.accounts.length > 0) {
        cfg.accounts.forEach(a => addAccount(a));
    } else {
        addAccount();
    }

    // Providers
    if (cfg.providers) {
        Object.entries(cfg.providers).forEach(([id, p]) => {
            addProvider({ ...p, _id: id });
        });
    }

    // Notifications
    if (cfg.notifications) {
        Object.entries(cfg.notifications).forEach(([k, v]) => {
            const el = document.getElementById('n_' + k);
            if (el) el.value = v || '';
        });
    }
}

function escapeHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function escapeAttr(s) {
    return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Boot
window.onload = function() {
    const cfg = loadConfig();
    loadFromConfig(cfg);
};
</script>
</body>
</html>
